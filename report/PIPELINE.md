# Пайплайн нормализации брендов

## Бизнес-задача

Автоматическое распознавание и нормализация упоминаний брендов в транскрибированных диалогах (звонки, чаты). Решение заменяет ошибочные или частично распознанные названия на корректные значения из эталонного справочника.

## Общая схема

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Генерация  │ -> │   Матчинг   │ -> │    LLM      │ -> │   Отчет     │
│  синонимов  │    │  по тексту  │    │ верификация │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## Этапы обработки

### Этап 1: Подготовка словаря синонимов

**Цель:** Расширить эталонный справочник брендов вариантами написания.

**Что происходит:**
- Для каждого бренда генерируются варианты: транслитерация, фонетические вариации, разговорные сокращения
- Создается инвертированный индекс для быстрого поиска

**Пример:**
- "Karcher" → ["керхер", "кархер", "кёрхер", "karcher"]
- "Bosch" → ["бош", "боше", "bosch"]

### Этап 2: Поиск кандидатов

**Цель:** Найти потенциальные упоминания брендов в каждом диалоге.

**Что происходит:**
- Текст разбивается на n-граммы (комбинации слов)
- Каждая n-грамма проверяется по индексу синонимов
- Формируется список кандидатов для верификации

**Результат:** Набор пар (бренд, найденный синоним) для каждого диалога.

### Этап 3: Верификация через LLM

**Цель:** Отфильтровать ложные срабатывания.

**Что происходит:**
- LLM анализирует контекст каждого упоминания
- Отсекаются совпадения, где слово используется не как бренд
- Для каждого подтвержденного бренда указывается уверенность

**Примеры фильтрации:**
- "Собака Майл Точка Ру" → НЕ бренд MiLe (это email)
- "станок Bosch" → ДА, бренд Bosch

### Этап 4: Формирование отчета

**Цель:** Подготовить итоговые файлы и метрики.

**Выходные данные:**
- `result.csv` — детализация по каждому найденному бренду
- `metrics.json` — Precision, Recall, F1
- `low_precision_brands.csv` — бренды с наибольшим количеством ошибок
- `report.xlsx` — сводный отчет для анализа расхождений

## Ключевые решения

1. **Фильтр коротких синонимов (≤3 символа)** — исключает ложные срабатывания на союзы и предлоги

2. **Контекстная верификация LLM** — отсекает email-адреса, имена людей, технические термины

3. **Фильтр confidence=0** — удаляет неуверенные предсказания модели

4. **Нормализация при сравнении** — учитывает варианты написания одного бренда

## Метрики качества

- **Precision** — доля правильных среди всех найденных
- **Recall** — доля найденных среди всех существующих
- **F1** — гармоническое среднее Precision и Recall

**Целевой показатель: F1 > 0.4**
